<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rad.typo</title>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #000;
            --link-color: #0000FF;
            --secondary-color: #666;
            --code-bg: #f5f5f5;
        }

        body {
            font-family: monospace;
            max-width: 800px;
            margin: 48px auto;
            padding: 24px;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        h1, h2 {
            margin: 0 0 24px 0;
            font-size: 24px;
        }

        h2 {
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: normal;
        }

        a {
            color: var(--link-color);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .header {
            margin-bottom: 30px;
            position: relative;
        }

        .back {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 14px;
        }

        .status {
            color: var(--secondary-color);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .breathing-dots::after {
            content: '';
            animation: breathe 4s infinite;
        }

        @keyframes breathe {
            0%, 100% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }

        .player {
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .now-playing {
            font-size: 20px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--secondary-color);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--secondary-color);
            border-radius: 4px;
            cursor: pointer;
            margin: 16px 0 4px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--text-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--secondary-color);
            margin-bottom: 16px;
        }

        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            border-top: 1px solid var(--secondary-color);
            padding-top: 16px;
        }

        .control-btn {
            background: none;
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            font-family: monospace;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .control-btn:hover {
            background-color: var(--code-bg);
        }

        .control-btn.active {
            background-color: var(--text-color);
            color: var(--bg-color);
            border-color: var(--text-color);
        }

        .section {
            margin: 20px 0;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }

        .section-header {
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header:hover {
            background-color: var(--secondary-color);
            color: var(--bg-color);
        }

        .section-content {
            padding: 15px;
            display: none;
        }

        .section-content.open {
            display: block;
            border-top: 1px solid var(--secondary-color);
        }

        .artwork-container {
            text-align: center;
            margin: 20px 0;
        }

        .song-artwork {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
        }

        .item-list {
            list-style: none;
            padding: 0;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--code-bg);
            cursor: pointer;
        }

        .item:hover {
            background-color: var(--code-bg);
            margin: 0 -10px;
            padding: 8px 10px;
        }

        .item.current {
            color: var(--link-color);
            font-weight: bold;
        }

        .item-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            gap: 15px;
        }

        .item-title {
            flex: 1;
            font-size: 13px;
        }

        .item-duration {
            color: var(--secondary-color);
            font-size: 13px;
        }

        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid var(--secondary-color);
            font-size: 14px;
            color: var(--secondary-color);
        }

        .footer a {
            color: var(--secondary-color);
        }

        @media (max-width: 600px) {
            body { 
                margin: 20px auto;
                padding: 15px;
            }
            
            .control-btn {
                padding: 14px;
                font-size: 26px;
                min-height: 52px;
                min-width: 52px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .control-btn#playBtn {
                min-width: 60px;
                min-height: 60px;
                font-size: 32px;
                padding-left: 16px;
            }
            
            .controls {
                gap: 10px;
                justify-content: center;
            }
            
            .progress-bar {
                height: 12px;
                margin: 20px 0 8px 0;
            }
            
            .section-header {
                padding: 15px;
                font-size: 16px;
            }
            
            .item { 
                padding: 15px 0;
                min-height: 44px;
            }
            
            .item:hover {
                padding: 15px 10px;
            }
            
            .item-title, .item-duration {
                font-size: 14px;
            }
            
            .now-playing {
                font-size: 18px;
            }
            
            .time-display {
                font-size: 16px;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="back">‚Üê back</a>
        <h1>rad.io</h1>
        <div class="status">derry: <span id="weather-temp">15</span>¬∞C <span id="weather-icon">‚òÅÔ∏è</span> | cpu: <span id="cpu-temp">54</span>¬∞C<span class="breathing-dots"></span></div>
    </header>

    <div class="player">
        <div class="now-playing" id="nowPlaying">vulture in the snow</div>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="totalTime">0:00</span>
        </div>

        <div class="controls">
            <button class="control-btn" id="prevBtn"><span class="desktop-text">‚Üê prev</span><span class="mobile-text">‚Üê</span></button>
            <button class="control-btn" id="playBtn"><span class="desktop-text">‚ñ∂ play</span><span class="mobile-text">‚ñ∂</span></button>
            <button class="control-btn" id="nextBtn"><span class="desktop-text">next ‚Üí</span><span class="mobile-text">‚Üí</span></button>
            <button class="control-btn" id="shuffleBtn"><span class="desktop-text">shuffle</span><span class="mobile-text">‚áÑ</span></button>
            <button class="control-btn" id="loopBtn"><span class="desktop-text">loop</span><span class="mobile-text">‚ü≤</span></button>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('artwork')">
            <span>artwork</span>
            <span class="toggle" id="artwork-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="artwork">
            <div class="artwork-container">
                <img id="currentArtwork" src="images/vulture-in-the-snow-single-artwork.jpg" 
                     alt="Current track artwork" class="song-artwork">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('playlist')">
            <span>songs</span>
            <span class="toggle" id="playlist-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="playlist">
            <ul class="item-list" id="playlistItems"></ul>
        </div>
    </div>

    <footer class="footer">
        ‚îî‚îÄ <a href="infrastructure.html">infrastructure</a> | <a href="telemetry.html">telemetry</a>
    </footer>

    <audio id="audioPlayer" preload="none"></audio>

    <script>
        const SONGS = [
            { 
                title: "vulture in the snow", 
                duration: "5:06", 
                file: "vulture-in-the-snow.mp3",
                artwork: "images/vulture-in-the-snow-single-artwork.jpg"
            },
            { 
                title: "straight and narrow", 
                duration: "3:58", 
                file: "straight-and-narrow.mp3",
                artwork: "images/straight-and-narrow-single-artwork.jpg"
            },
            { 
                title: "frontal lobe fritz", 
                duration: "4:06", 
                file: "frontal-lobe-fritz.mp3",
                artwork: "images/frontal-lobe-fritz-single-artwork.jpg"
            },
            { 
                title: "what now", 
                duration: "4:22", 
                file: "what-now.mp3",
                artwork: "images/what-now-single-artwork.jpg"
            },
            { 
                title: "the one we didn't get to record with steve albini", 
                duration: "4:07", 
                file: "the-one-we-didnt-get-to-record-with-steve-albini.mp3",
                artwork: "images/the-one-we-didnt-get-to-record-with-steve-albini-single-artwork.jpg"
            },
            { 
                title: "hard hitter", 
                duration: "4:53", 
                file: "hard-hitter.mp3",
                artwork: "https://radtypo.com/images/hard-hitter-single-artwork.jpg"
            },
            { 
                title: "it ain't pretty", 
                duration: "4:57", 
                file: "it-aint-pretty.mp3",
                artwork: "images/it-aint-pretty-artwork.jpg"
            },
            { 
                title: "muriel", 
                duration: "4:03", 
                file: "muriel.mp3",
                artwork: "images/muriel-artwork.jpg"
            },
            { 
                title: "rad typo", 
                duration: "4:19", 
                file: "rad-typo.mp3",
                artwork: "images/rad-typo-artwork.jpg"
            },
            { 
                title: "birthday cake", 
                duration: "3:53", 
                file: "birthday-cake.mp3",
                artwork: "images/birthday-cake-artwork.jpg"
            },
            { 
                title: "what's not to like", 
                duration: "2:41", 
                file: "whats-not-to-like.mp3",
                artwork: "images/whats-not-to-like-artwork.jpg"
            },
            { 
                title: "bad fortune", 
                duration: "3:42", 
                file: "bad-fortune.mp3",
                artwork: "images/bad-fortune-artwork.jpg"
            }
        ];

        class RadioPlayer {
            constructor() {
                this.currentIndex = 0;
                this.isPlaying = false;
                this.isShuffled = false;
                this.isLooped = false;
                this.shuffledPlaylist = [];
                
                this.elements = {
                    audio: document.getElementById('audioPlayer'),
                    playBtn: document.getElementById('playBtn'),
                    prevBtn: document.getElementById('prevBtn'),
                    nextBtn: document.getElementById('nextBtn'),
                    shuffleBtn: document.getElementById('shuffleBtn'),
                    loopBtn: document.getElementById('loopBtn'),
                    progressBar: document.getElementById('progressBar'),
                    progressFill: document.getElementById('progressFill'),
                    currentTime: document.getElementById('currentTime'),
                    totalTime: document.getElementById('totalTime'),
                    nowPlaying: document.getElementById('nowPlaying'),
                    artwork: document.getElementById('currentArtwork'),
                    playlistItems: document.getElementById('playlistItems')
                };
                
                this.init();
            }

            init() {
                this.createPlaylist();
                this.loadState();
                this.bindEvents();
                this.setupMediaSession();
                this.startWeatherUpdates();
                this.startStateAutoSave();
                this.setupResponsiveButtons();
            }

            setupResponsiveButtons() {
                const updateButtonText = () => {
                    const isMobile = window.innerWidth <= 600;
                    document.querySelectorAll('.desktop-text').forEach(el => {
                        el.style.display = isMobile ? 'none' : 'inline';
                    });
                    document.querySelectorAll('.mobile-text').forEach(el => {
                        el.style.display = isMobile ? 'inline' : 'none';
                    });
                };
                
                updateButtonText();
                window.addEventListener('resize', updateButtonText);
            }

            bindEvents() {
                this.elements.playBtn.addEventListener('click', () => this.togglePlay());
                this.elements.prevBtn.addEventListener('click', () => this.previousTrack());
                this.elements.nextBtn.addEventListener('click', () => this.nextTrack());
                this.elements.shuffleBtn.addEventListener('click', () => this.toggleShuffle());
                this.elements.loopBtn.addEventListener('click', () => this.toggleLoop());
                this.elements.progressBar.addEventListener('click', (e) => this.seekTo(e));
                this.elements.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.elements.audio.addEventListener('ended', () => this.handleTrackEnd());
                this.elements.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                window.addEventListener('beforeunload', () => this.handlePageUnload());
            }

            createPlaylist() {
                this.elements.playlistItems.innerHTML = SONGS.map((song, index) => `
                    <li class="item" data-index="${index}">
                        <div class="item-info">
                            <span class="item-title">${song.title}</span>
                        </div>
                        <span class="item-duration">${song.duration}</span>
                    </li>
                `).join('');

                this.elements.playlistItems.addEventListener('click', (e) => {
                    const item = e.target.closest('.item');
                    if (item) this.playTrack(parseInt(item.dataset.index));
                });
            }

            playTrack(index) {
                this.currentIndex = index;
                const song = SONGS[this.currentIndex];
                
                this.elements.audio.src = `audio/${song.file}`;
                this.elements.nowPlaying.textContent = song.title;
                this.elements.artwork.src = song.artwork;
                this.elements.artwork.alt = `${song.title} artwork`;
                
                this.updatePlaylistHighlight();
                this.updateMediaSessionMetadata();
                
                if (this.isPlaying) {
                    this.elements.audio.play().catch(console.error);
                }
            }

            togglePlay() {
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            play() {
                if (!this.elements.audio.src) {
                    this.playTrack(this.currentIndex);
                }
                
                this.elements.audio.play().then(() => {
                    this.isPlaying = true;
                    const isMobile = window.innerWidth <= 600;
                    this.elements.playBtn.querySelector('.desktop-text').textContent = '‚è∏ pause';
                    this.elements.playBtn.querySelector('.mobile-text').textContent = '‚è∏';
                }).catch(console.error);
            }

            pause() {
                this.elements.audio.pause();
                this.isPlaying = false;
                const isMobile = window.innerWidth <= 600;
                this.elements.playBtn.querySelector('.desktop-text').textContent = '‚ñ∂ play';
                this.elements.playBtn.querySelector('.mobile-text').textContent = '‚ñ∂';
            }

            previousTrack() {
                const playlist = this.getPlaylist();
                const currentIndex = playlist.indexOf(this.currentIndex);
                const prevIndex = currentIndex > 0 ? currentIndex - 1 : playlist.length - 1;
                this.playTrack(playlist[prevIndex]);
            }

            nextTrack() {
                const playlist = this.getPlaylist();
                const currentIndex = playlist.indexOf(this.currentIndex);
                const nextIndex = currentIndex < playlist.length - 1 ? currentIndex + 1 : 0;
                this.playTrack(playlist[nextIndex]);
            }

            toggleShuffle() {
                this.isShuffled = !this.isShuffled;
                this.elements.shuffleBtn.classList.toggle('active', this.isShuffled);
                
                if (this.isShuffled) {
                    this.generateShuffledPlaylist();
                }
            }

            toggleLoop() {
                this.isLooped = !this.isLooped;
                this.elements.loopBtn.classList.toggle('active', this.isLooped);
                this.elements.audio.loop = this.isLooped;
            }

            generateShuffledPlaylist() {
                this.shuffledPlaylist = Array.from({length: SONGS.length}, (_, i) => i);
                for (let i = this.shuffledPlaylist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.shuffledPlaylist[i], this.shuffledPlaylist[j]] = [this.shuffledPlaylist[j], this.shuffledPlaylist[i]];
                }
            }

            getPlaylist() {
                return this.isShuffled ? this.shuffledPlaylist : Array.from({length: SONGS.length}, (_, i) => i);
            }

            seekTo(event) {
                if (!this.elements.audio.duration) return;
                
                const rect = this.elements.progressBar.getBoundingClientRect();
                const progress = (event.clientX - rect.left) / rect.width;
                this.elements.audio.currentTime = progress * this.elements.audio.duration;
            }

            updateProgress() {
                if (!this.elements.audio.duration) return;
                
                const progress = (this.elements.audio.currentTime / this.elements.audio.duration) * 100;
                this.elements.progressFill.style.width = `${progress}%`;
                this.elements.currentTime.textContent = this.formatTime(this.elements.audio.currentTime);
            }

            updateDuration() {
                this.elements.totalTime.textContent = this.formatTime(this.elements.audio.duration);
            }

            updatePlaylistHighlight() {
                document.querySelectorAll('.item').forEach((item, i) => {
                    item.classList.toggle('current', i === this.currentIndex);
                });
            }

            handleTrackEnd() {
                if (!this.isLooped) {
                    this.nextTrack();
                }
            }

            handlePageUnload() {
                if (this.isPlaying) {
                    this.elements.audio.pause();
                }
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            saveState() {
                const state = {
                    currentIndex: this.currentIndex,
                    isShuffled: this.isShuffled,
                    isLooped: this.isLooped,
                    shuffledPlaylist: this.shuffledPlaylist,
                    currentTime: this.elements.audio.currentTime || 0
                };
                localStorage.setItem('radioState', JSON.stringify(state));
            }

            loadState() {
                const saved = localStorage.getItem('radioState');
                if (!saved) {
                    this.playTrack(0);
                    return;
                }

                const state = JSON.parse(saved);
                this.currentIndex = state.currentIndex || 0;
                this.isShuffled = state.isShuffled || false;
                this.isLooped = state.isLooped || false;
                this.shuffledPlaylist = state.shuffledPlaylist || [];
                
                this.elements.shuffleBtn.classList.toggle('active', this.isShuffled);
                this.elements.loopBtn.classList.toggle('active', this.isLooped);
                this.elements.audio.loop = this.isLooped;
                
                this.playTrack(this.currentIndex);
                
                if (state.currentTime > 0) {
                    this.elements.audio.addEventListener('loadeddata', () => {
                        this.elements.audio.currentTime = state.currentTime;
                    }, { once: true });
                }
            }

            setupMediaSession() {
                if (!('mediaSession' in navigator)) return;
                
                navigator.mediaSession.setActionHandler('play', () => this.togglePlay());
                navigator.mediaSession.setActionHandler('pause', () => this.togglePlay());
                navigator.mediaSession.setActionHandler('previoustrack', () => this.previousTrack());
                navigator.mediaSession.setActionHandler('nexttrack', () => this.nextTrack());
            }

            updateMediaSessionMetadata() {
                if (!('mediaSession' in navigator)) return;
                
                const song = SONGS[this.currentIndex];
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: 'rad.typo',
                    album: 'rad.io collection',
                    artwork: [{ src: song.artwork, sizes: '512x512', type: 'image/jpeg' }]
                });
            }

            async updateWeather() {
                try {
                    const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=55.014662&longitude=-7.302903&current=temperature_2m,weather_code&timezone=Europe%2FLondon');
                    const data = await response.json();
                    
                    if (data.current) {
                        const temp = Math.round(data.current.temperature_2m);
                        document.getElementById('weather-temp').textContent = temp;
                        
                        const iconMap = {
                            0: '‚òÄÔ∏è', 1: '‚òÅÔ∏è', 2: '‚òÅÔ∏è', 3: '‚òÅÔ∏è',
                            45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                            51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è', 56: 'üåßÔ∏è', 57: 'üåßÔ∏è',
                            61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è', 66: 'üåßÔ∏è', 67: 'üåßÔ∏è',
                            71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è', 77: 'üå®Ô∏è',
                            80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
                            95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
                        };
                        
                        document.getElementById('weather-icon').textContent = iconMap[data.current.weather_code] || '‚òÅÔ∏è';
                    }
                } catch (error) {
                    console.log('Weather update failed:', error);
                }
            }

            async updateCpuTemp() {
                try {
                    const response = await fetch('/api/stats.json');
                    const data = await response.json();
                    
                    if (data.thermal?.cpu_temp) {
                        const temp = data.thermal.cpu_temp.replace('¬∞C', '');
                        document.getElementById('cpu-temp').textContent = temp;
                    }
                } catch (error) {
                    console.log('CPU temperature update failed:', error);
                }
            }

            startWeatherUpdates() {
                this.updateWeather();
                this.updateCpuTemp();
                setInterval(() => this.updateCpuTemp(), 30000);
                setInterval(() => this.updateWeather(), 300000);
            }

            startStateAutoSave() {
                setInterval(() => this.saveState(), 5000);
            }
        }

        function toggleSection(id) {
            const content = document.getElementById(id);
            const toggle = document.getElementById(id + '-toggle');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.textContent = '[ + ]';
            } else {
                content.classList.add('open');
                toggle.textContent = '[ - ]';
            }
        }

        // Initialize the radio player
        new RadioPlayer();
    </script>
</body>
</html>