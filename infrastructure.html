<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>infrastructure - rad.typo</title>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #000;
            --link-color: #0000FF;
            --secondary-color: #666;
            --code-bg: #f5f5f5;
        }

        body {
            font-family: monospace;
            max-width: 800px;
            margin: 48px auto;
            padding: 24px;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        h1, h2 {
            margin: 0;
            padding: 0;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 24px;
        }

        h2 {
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: normal;
        }

        a {
            color: var(--link-color);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .header {
            margin-bottom: 30px;
            position: relative;
        }

        .back {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 14px;
        }

        .site-title { color: inherit; text-decoration: none; }
        .site-title:hover { text-decoration: none; }

        .status {
            color: var(--secondary-color);
            font-size: 14px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .breathing-dots::after {
            content: '';
            animation: breathe 4s infinite;
        }

        @keyframes breathe {
            0%, 100% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }

        .kp-circle {
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--kp-color, #2ecc71);
            transition: background 0.5s ease;
            display: inline-block;
        }

        .album-info {
            margin-bottom: 40px;
        }

        .album-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .album-header h2 {
            margin: 0;
            font-weight: bold;
        }

        .intro-text {
            color: var(--text-color);
            font-size: 14px;
            font-style: italic;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .server-image {
            text-align: center;
            margin: 30px 0;
        }

        .pi-image {
            max-width: 100%;
            max-height: 400px;
            cursor: pointer;
        }

        .section {
            margin: 20px 0;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }

        .section-header {
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }

        .section-header:hover {
            background-color: var(--secondary-color);
            color: var(--bg-color);
        }

        .section-content {
            padding: 15px;
            display: none;
        }

        .section-content.open {
            display: block;
            border-top: 1px solid var(--secondary-color);
        }

        .specs-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 16px;
        }

        .specs-grid dt {
            color: var(--secondary-color);
            font-weight: normal;
        }

        .specs-grid dd {
            margin: 0;
        }

        .decision-item {
            margin: 20px 0;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--code-bg);
        }

        .decision-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .decision-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .decision-choice {
            margin: 8px 0;
        }

        .decision-rationale {
            margin: 8px 0;
            color: var(--text-color);
        }

        .philosophy-item {
            margin: 12px 0;
        }

        .philosophy-term {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .inspiration-links {
            margin: 20px 0;
        }

        .inspiration-links a {
            display: block;
            margin: 8px 0;
            color: var(--link-color);
        }

        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid var(--secondary-color);
            font-size: 14px;
            color: var(--secondary-color);
        }

        .footer a {
            color: var(--secondary-color);
        }

        @media (max-width: 600px) {
            body {
                margin: 20px auto;
                padding: 15px;
            }

            .specs-grid {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .specs-grid dt {
                margin-top: 12px;
            }

            .specs-grid dt:first-child {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="back">‚Üê back</a>
        <h1><a href="/" class="site-title">rad.typo</a></h1>
        <div class="status">
            derry: <span id="weather-temp">-</span>¬∞C <span id="weather-icon">‚õÖ</span> |
            kp: <span class="kp-circle"></span><span id="kp-value">-</span> |
            cpu: <span id="cpu-temp">-</span>¬∞C<span class="breathing-dots"></span>
        </div>
    </header>

    <div class="album-info">
        <div class="album-header">
            <h2>infrastructure</h2>
        </div>
    </div>

    <div class="intro-text">
        rad.typo runs on a single-board computer connected to a home internet connection in derry. no cloud, no data centers, no build pipeline. songs, poems, and releases are stored as flat JSON files and rendered client-side by a single template per content type. at times the site may go down or get slow...
    </div>

    <div class="server-image">
        <img src="images/raspberry-pi-server.jpg"
             alt="Raspberry Pi 3B+ server running 24/7 in Derry"
             class="pi-image">
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('hardware')">
            <span>hardware specifications</span>
            <span class="toggle" id="hardware-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="hardware">
            <dl class="specs-grid">
                <dt>computer</dt>
                <dd>Raspberry Pi 3 Model B Plus Rev 1.3</dd>
                <dt>cpu</dt>
                <dd>ARM Cortex-A53 1.4GHz quad-core</dd>
                <dt>memory</dt>
                <dd>1GB LPDDR2 SDRAM (921MB usable)</dd>
                <dt>storage</dt>
                <dd>64GB microSD (SanDisk Ultra)</dd>
                <dt>network</dt>
                <dd>10/100 Ethernet (eth0)</dd>
                <dt>power consumption</dt>
                <dd>~2.4W idle ‚Ä¢ ~3.0‚Äì3.8W under load</dd>
            </dl>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('software')">
            <span>software stack</span>
            <span class="toggle" id="software-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="software">
            <dl class="specs-grid">
                <dt>operating system</dt>
                <dd>Raspberry Pi OS Lite (Debian 12)</dd>
                <dt>web server</dt>
                <dd>Apache 2.4.62 with mod_rewrite</dd>
                <dt>server-side</dt>
                <dd>PHP (email subscriptions only)</dd>
                <dt>frontend</dt>
                <dd>vanilla HTML/CSS/JS ‚Äî no frameworks, no build step</dd>
                <dt>content layer</dt>
                <dd>flat JSON files (songs.json, poems.json) rendered client-side by a single template per type</dd>
                <dt>url routing</dt>
                <dd>.htaccess rewrite rules map /songs/*.html and /poems/*.html to their respective templates</dd>
                <dt>audio</dt>
                <dd>MP3 served directly by Apache ‚Äî HTML5 audio element, no proprietary codecs</dd>
                <dt>radio</dt>
                <dd>Fisher-Yates shuffle queue, MediaSession API for lock screen controls</dd>
                <dt>payments</dt>
                <dd>Stripe hosted checkout ‚Äî no card data touches the server</dd>
                <dt>ssl certificate</dt>
                <dd>Let's Encrypt (auto-renewing)</dd>
                <dt>dns</dt>
                <dd>DuckDNS dynamic DNS</dd>
                <dt>security</dt>
                <dd>UFW firewall + fail2ban + SSH key auth</dd>
                <dt>monitoring</dt>
                <dd>bash scripts on a cron, writing to /api/stats.json every 60 seconds</dd>
                <dt>status bar caching</dt>
                <dd>sessionStorage IIFE restores weather, KP, and CPU values instantly on every page load</dd>
            </dl>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('apis')">
            <span>external APIs</span>
            <span class="toggle" id="apis-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="apis">
            <dl class="specs-grid">
                <dt>weather</dt>
                <dd>Open-Meteo ‚Äî temperature and weather code at Derry coordinates (55.0147¬∞N, 7.3029¬∞W) ¬∑ polled every 5 minutes</dd>
                <dt>solar activity</dt>
                <dd>NOAA Space Weather Prediction Center ‚Äî planetary K-index (NOAA-scale geomagnetic storm indicator) ¬∑ polled every 5 minutes ¬∑ color-coded 0‚Äì9 from quiet green to extreme storm purple</dd>
                <dt>server telemetry</dt>
                <dd>/api/stats.json ‚Äî local endpoint generated by bash script ¬∑ CPU temp, GPU temp, memory, disk, uptime, network I/O, Apache request count ¬∑ refreshed every 30 seconds</dd>
                <dt>payments</dt>
                <dd>Stripe ‚Äî hosted checkout links only, no client-side Stripe SDK</dd>
            </dl>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('decisions')">
            <span>technical decisions</span>
            <span class="toggle" id="decisions-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="decisions">
            <div class="decision-item">
                <div class="decision-title">Apache vs Nginx</div>
                <div class="decision-choice"><strong>Choice:</strong> Apache 2.4.62</div>
                <div class="decision-rationale"><strong>Rationale:</strong> .htaccess support allows URL routing changes without root access. The template system depends on per-directory rewrite rules ‚Äî Apache handles this cleanly with RewriteCond and RewriteRule. Performance difference vs Nginx is negligible at this scale. Memory overhead of 50‚Äì100MB is acceptable within our 921MB budget.</div>
            </div>

            <div class="decision-item">
                <div class="decision-title">Flat JSON over a Database</div>
                <div class="decision-choice"><strong>Choice:</strong> songs.json + poems.json as the content layer</div>
                <div class="decision-rationale"><strong>Rationale:</strong> Eliminating a database removes the largest attack surface entirely. JSON files are readable, diffable, and version-controlled alongside the rest of the site. No query overhead, no connection pooling, no migrations. A bash script generates /api/stats.json for server telemetry ‚Äî the same philosophy applied to monitoring.</div>
            </div>

            <div class="decision-item">
                <div class="decision-title">Single Template per Content Type</div>
                <div class="decision-choice"><strong>Choice:</strong> song-template.html and poems-template.html, routed via .htaccess</div>
                <div class="decision-rationale"><strong>Rationale:</strong> Adding a new song or poem means editing one JSON file. No HTML file is created per piece of content. Apache rewrites /songs/bad-fortune.html to /song-template.html?id=bad-fortune ‚Äî the template fetches the JSON, finds the entry by key, and renders the page client-side. 301 redirects handle legacy URL paths.</div>
            </div>

            <div class="decision-item">
                <div class="decision-title">sessionStorage for Status Bar Caching</div>
                <div class="decision-choice"><strong>Choice:</strong> Synchronous IIFE restores cached weather, KP, and CPU values before the first render</div>
                <div class="decision-rationale"><strong>Rationale:</strong> API calls to Open-Meteo and NOAA take 200‚Äì800ms. Without caching, the status bar flickers with dashes on every page load. The IIFE runs synchronously during HTML parse, restoring last-known values from sessionStorage instantly ‚Äî then async fetches update them in the background. Result: the status bar appears populated even on cold navigation.</div>
            </div>

            <div class="decision-item">
                <div class="decision-title">Monospace Typography</div>
                <div class="decision-choice"><strong>Choice:</strong> System monospace stack ‚Äî no web fonts</div>
                <div class="decision-rationale"><strong>Rationale:</strong> No font downloads means no render-blocking requests and no third-party tracking. The constraint also fits: monospace is the natural environment for code, terminals, and technical writing. The site reads like a document rather than a product.</div>
            </div>

            <div class="decision-item">
                <div class="decision-title">Real-time Telemetry Polling</div>
                <div class="decision-choice"><strong>Choice:</strong> 30-second client polling of 60-second server updates (CPU) ¬∑ 5-minute polling for weather and KP index</div>
                <div class="decision-rationale"><strong>Rationale:</strong> CPU temperature changes meaningfully over 30‚Äì60 seconds under varying load. Weather and geomagnetic activity move slowly ‚Äî 5-minute polling is honest. More frequent calls would waste Pi cycles and NOAA bandwidth without surfacing meaningful change. The telemetry page extends this with 24-hour rolling charts stored in localStorage.</div>
            </div>

            <div class="decision-item">
                <div class="decision-title">Stripe for Payments</div>
                <div class="decision-choice"><strong>Choice:</strong> Hosted checkout links, no Stripe SDK loaded on-site</div>
                <div class="decision-rationale"><strong>Rationale:</strong> A Pi on a home connection should not be processing card data. Stripe's hosted checkout handles PCI compliance entirely off-server. The implementation is three URL constants and a window.open() call ‚Äî no client-side library, no webhook surface, no card data ever touches Derry.</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('philosophy')">
            <span>design philosophy</span>
            <span class="toggle" id="philosophy-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="philosophy">
            <div class="philosophy-item">
                <div class="philosophy-term">visible infrastructure:</div>
                <div>The Pi's CPU temperature appears in the header of every page. Visitors see the physical reality of the server they're reading from ‚Äî warm, constrained, real.</div>
            </div>
            <div class="philosophy-item">
                <div class="philosophy-term">sustainable computing:</div>
                <div>~3W continuous vs 50‚Äì200W for a typical cloud instance. ~0.2kg CO‚ÇÇ/month vs ~12kg for equivalent traditional hosting. A single LED bulb uses more power than the entire server.</div>
            </div>
            <div class="philosophy-item">
                <div class="philosophy-term">no dependencies:</div>
                <div>No npm. No build step. No framework. Editing a file makes it live. The entire frontend is readable source ‚Äî view-source tells you everything.</div>
            </div>
            <div class="philosophy-item">
                <div class="philosophy-term">local infrastructure:</div>
                <div>Home internet connection, no CDN, no cloud abstraction. The latency you experience is the latency of Derry.</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('inspiration')">
            <span>inspiration</span>
            <span class="toggle" id="inspiration-toggle">[ + ]</span>
        </div>
        <div class="section-content" id="inspiration">
            <div class="inspiration-links">
                <a href="https://solar.lowtechmagazine.com/" target="_blank">https://solar.lowtechmagazine.com/</a>
                <a href="https://elly.town/" target="_blank">https://elly.town/</a>
            </div>
        </div>
    </div>

    <footer class="footer">
        ‚îî‚îÄ <a href="/telemetry.html">telemetry</a>
    </footer>

    <script>
        const KP_COLORS = {
            0: { color: '#2ecc71', label: 'Quiet' },
            1: { color: '#2ecc71', label: 'Quiet' },
            2: { color: '#2ecc71', label: 'Quiet' },
            3: { color: '#f1c40f', label: 'Unsettled' },
            4: { color: '#f39c12', label: 'Active' },
            5: { color: '#e67e22', label: 'Minor Storm' },
            6: { color: '#e74c3c', label: 'Moderate Storm' },
            7: { color: '#c0392b', label: 'Strong Storm' },
            8: { color: '#8e44ad', label: 'Severe Storm' },
            9: { color: '#6c3483', label: 'Extreme Storm' }
        };

        function toggleSection(id) {
            const content = document.getElementById(id);
            const toggle = document.getElementById(id + '-toggle');
            content.classList.toggle('open');
            toggle.textContent = content.classList.contains('open') ? '[ - ]' : '[ + ]';
        }

        async function updateWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=55.014662&longitude=-7.302903&current=temperature_2m,weather_code&timezone=Europe%2FLondon');
                const data = await response.json();
                if (data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    document.getElementById('weather-temp').textContent = temp;
                    const code = data.current.weather_code;
                    let icon = '‚õÖ';
                    if (code === 0) icon = '‚òÄÔ∏è';
                    else if (code <= 3) icon = '‚õÖ';
                    else if (code <= 48) icon = 'üå´Ô∏è';
                    else if (code <= 67) icon = 'üåßÔ∏è';
                    else if (code <= 77) icon = 'üå®Ô∏è';
                    else if (code <= 82) icon = 'üå¶Ô∏è';
                    else if (code >= 95) icon = '‚õàÔ∏è';
                    document.getElementById('weather-icon').textContent = icon;
                    try { sessionStorage.setItem('rt_weather', JSON.stringify({ temp: String(temp), icon })); } catch(e) {}
                }
            } catch (error) { console.log('Weather fetch failed:', error); }
        }

        async function updateCpuTemp() {
            try {
                const response = await fetch('/api/stats.json');
                const data = await response.json();
                if (data.thermal?.cpu_temp) {
                    const temp = Math.round(parseFloat(data.thermal.cpu_temp.replace('¬∞C', '')));
                    document.getElementById('cpu-temp').textContent = temp;
                    try { sessionStorage.setItem('rt_cpu', JSON.stringify({ temp })); } catch(e) {}
                }
            } catch (error) { console.log('Stats fetch failed:', error); }
        }

        async function updateKPIndex() {
            try {
                const response = await fetch('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json');
                const data = await response.json();
                const kpValue = parseFloat(data[data.length - 1][1]);
                const kpClamped = Math.min(9, Math.max(0, kpValue));
                const kpRounded = Math.round(kpClamped);
                const colorData = KP_COLORS[kpRounded];
                document.querySelector('.kp-circle').style.setProperty('--kp-color', colorData.color);
                document.getElementById('kp-value').textContent = kpClamped.toFixed(1);
                try { sessionStorage.setItem('rt_kp', JSON.stringify({ value: kpClamped.toFixed(1), color: colorData.color, label: colorData.label })); } catch(e) {}
            } catch (error) { console.log('KP fetch failed:', error); }
        }

        // Restore status bar from cache instantly before fetching fresh data
        (function() {
            try {
                const w = sessionStorage.getItem('rt_weather');
                if (w) { const d = JSON.parse(w); document.getElementById('weather-temp').textContent = d.temp; document.getElementById('weather-icon').textContent = d.icon; }
                const k = sessionStorage.getItem('rt_kp');
                if (k) { const d = JSON.parse(k); document.querySelector('.kp-circle').style.setProperty('--kp-color', d.color); document.getElementById('kp-value').textContent = d.value; }
                const c = sessionStorage.getItem('rt_cpu');
                if (c) { const d = JSON.parse(c); document.getElementById('cpu-temp').textContent = d.temp; }
            } catch(e) {}
        })();

        updateWeather();
        updateCpuTemp();
        updateKPIndex();
        setInterval(updateCpuTemp, 30000);
        setInterval(updateWeather, 300000);
        setInterval(updateKPIndex, 300000);
    </script>
</body>
</html>
